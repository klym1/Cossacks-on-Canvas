(function(){function e(e,t){this.width=e,this.height=t,this.units=[],this.TimeQuantumNumber=0,this.QuantumEpoch=0,this.TickTime=30,this.Run=function(){var e=this;setInterval(function(){for(var t=0;t<e.units.length;t++)e.units[t].tick();e.TimeQuantumNumber++,e.TimeQuantumNumber==1024&&(e.QuantumEpoch++,e.TimeQuantumNumber=0)},this.TickTime)}}function t(e){this.criteria=e,this.length=0,this.queue=[]}function n(e,t){this.unit=e,this.commandsQueue=t,this.HighPriorityInterruption=!1,this.commandIsExecuting=!1,this.currentCommand=null}function r(e){this.commandHandler=e.commandHandler,this.callback=e.callback,this.finishConditions=e.finishConditions,this.i=0,this.initialised=!1,this.init=e.init,this.initData={},this.priority=e.priority||0,this.Execute=function(){this.initialised===!1&&this.init!==undefined&&(this.initData=this.init(this.commandHandler.unit),this.initialised=!0),this.callback(this.commandHandler.unit,this.i,this.initData),this.commandHandler.commandIsExecuting=!0,this.i++,this.finishConditions(this.commandHandler.unit,this.i)===!0&&(this.commandHandler.commandIsExecuting=!1)}}function i(e,t,n){this.name=e,this.hp=100,this.speed=2.3,this.x=0,this.y=0,this.states=[],this.n=0,this.activeState=0,this.commandHandler=t.CreateCommandHandler(this),this.commandModule=n,this.State={},this.IsSelected=!1}function s(e,t,n,r,i,s,o){this.spriteName=e,this.spriteWidth=n,this.spriteHeight=t,this.j=0,this.k=r,this.Id=i,this.xSymmetry=s,this.ySymmetry=o}function o(e,t,n){this.store=e._resources,this.imagesAdded=0,this.imagesLoaded=0,this.add=function(e,r){var i=this,s=new Image;s.onload=function(){i.imagesLoaded++,n(i.imagesAdded,i.imagesLoaded),i.imagesAdded==i.imagesLoaded&&t()},s.src=e,this.store[r]=s,this.imagesAdded++}}function u(e){this.unit=e}function a(e){document.getElementById("world-info").innerHTML="mouseup"}function f(e,t,n){var r=new Date;this._resources={},this.world=e.world,this.unitHandlerModule=n,this.canvas_height=e.height,this.canvas_width=e.width,this.canvasOffsetX=0,this.canvasOffsetY=0,this.canvas=document.getElementById("can"),this.canvas.width=this.canvas_width,this.canvas.height=this.canvas_height,this.ctx=this.canvas.getContext("2d"),this.gameLoop=function(){var e=this,t=e.gameLoop.bind(e);window.requestAnimationFrame(t),e.RenderUnits()},this.uppendLine=function(e){var t=new Date-r,n=Math.floor(t%36e5/6e4),i=Math.floor(t%6e4/1e3),s=Math.floor(t%1e3);document.getElementById("loading-container").innerHTML+="["+n+":"+i+"."+s+"] "+e+"<p>"},this.mouseDownHandler=function(e){var t=e.offsetX,n=e.offsetY;e.button==2&&(this.HandleMouseLeftClick.bind(this)(e),window.removeEventListener("mouseup",a,!1));for(var r=0;r<this.world.units.length;r++){var i=this.world.units[r],s=20,o=70;i.IsSelected=i.x+i.State.xSymmetry-s<t&&i.x+i.State.xSymmetry+s>t&&i.y+i.State.ySymmetry-o<n&&i.y+i.State.ySymmetry+o>n}document.getElementById("world-info").innerHTML="mousedown"},this.CenterView=function(){this.canvasOffsetX=(this.world.width-this.canvas_width)/2,this.canvasOffsetY=(this.world.height-this.canvas_height)/2},this.MoveCanvasToRight=function(){this.canvasOffsetX+=50},this.MoveCanvasToLeft=function(){this.canvasOffsetX-=50},this.MoveCanvasToUp=function(){this.canvasOffsetY-=50},this.MoveCanvasToDown=function(){this.canvasOffsetY+=50},this.HandleMouseLeftClick=function(e){var t=this.unitHandlerModule.CreateHandler(this.unit);t.Go(12,23)},this.mouseUpHandler=function(e){document.getElementById("world-info").innerHTML="mouseup"},this.init=function(){var e=this;document.getElementById("can").addEventListener("mousedown",this.mouseDownHandler.bind(this));var n=t.SetUp(this,function(){e.uppendLine("Loading finished in "),e.gameLoop.bind(e)()},function(t,n){e.uppendLine((n/t*100+"").substring(0,6)+" %")});for(var r=0;r<sprites.length;r++)n.add("sprites_png/"+sprites[r].UnitName+".png",sprites[r].UnitName)},this.ToCanvasX=function(e){return e-this.canvasOffsetX},this.ToCanvasY=function(e){return e-this.canvasOffsetY},this.RenderUnits=function(){this.WriteStatusInfo(this.world),this.ctx.clearRect(0,0,this.canvas_width,this.canvas_height);var e=this.world.units;for(var t=e.length-1;t>=0;t--){var n=e[t],r=n.State,i=r.spriteWidth,s=r.spriteHeight,o=i*n.n,u=s*r.j,a=this._resources[r.spriteName];n.IsSelected===!0&&this.drawEllipseWithEllipse(this.ctx,this.ToCanvasX(n.x+r.xSymmetry),this.ToCanvasY(n.y+r.ySymmetry),25,10),this.ctx.drawImage(a,o,u,i,s,this.ToCanvasX(n.x),this.ToCanvasY(n.y),i,s)}},this.drawEllipseWithEllipse=function(e,t,n,r,i){e.ellipse&&(e.beginPath(),e.ellipse(t,n,r,i,0,0,Math.PI*2),e.strokeStyle="#0000ff",e.stroke(),e.lineWidth=3)},this.WriteStatusInfo=function(e){c===!0?document.getElementById("unit-info").innerHTML=this.MaterializeStatusData(this.GetInfoRecursively(e.units[0].commandsQueue)):(document.getElementById("world-info").innerHTML=null,document.getElementById("unit-info").innerHTML=null)},this.MaterializeStatusData=function(e){var t="";for(var n=0;n<e.length;n++){var r=e[n];t+=r[0]+": "+r[1]+"</p>"}return t},this.GetInfoRecursively=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&typeof e[n]!="function"&&t.push([n,e[n]]);return t}}function l(e){this.world=e.world,this.render=e.render,this.height=e.height}define("World",[],function(){return{CreateNewWorld:function(t,n){return new e(t,n)}}}),define("PriorityQueue",[],function(){return{CreatePriorityQueue:function(e){return new t(e)}}}),t.prototype.IsEmpty=function(){return this.queue.length===0},t.prototype.insert=function(e){if(!e.hasOwnProperty(this.criteria))throw"Cannot insert "+e+" because it does not have a property by the name of "+this.criteria+".";this.queue.push(e),this.length++,this.bubbleUp(this.length-1)},t.prototype.getHighestPriorityElement=function(){return this.queue[0]},t.prototype.shiftHighestPriorityElement=function(){return this.length--,this.queue.shift()},t.prototype.bubbleUp=function(e){if(e===0)return;for(var t=this.queue.length-1;t>0;t--)this.queue[t][this.criteria]>this.queue[t-1][this.criteria]&&this.swap(t-1,t)},t.prototype.swap=function(e,t){var n=this.queue[e];this.queue[e]=this.queue[t],this.queue[t]=n},define("CommandHandler",["PriorityQueue"],function(e){var t=e.CreatePriorityQueue("priority");return{CreateCommandHandler:function(e){return new n(e,t)}}}),n.prototype.AddCommand=function(e){this.commandsQueue.insert(e)},n.prototype.HandleCommandQueue=function(){if(this.commandsQueue.IsEmpty()){if(this.commandIsExecuting===!1){var e=this.unit.GetDefaultCommand();this.AddCommand(e)}}else{var t=this.commandsQueue.getHighestPriorityElement();this.currentCommand.priority<t.priority&&(this.AddCommand(this.currentCommand),this.HighPriorityInterruption=!0)}if(this.commandIsExecuting===!1||this.HighPriorityInterruption)this.currentCommand=this.commandsQueue.shiftHighestPriorityElement(),this.HighPriorityInterruption=!1;this.currentCommand.Execute()},define("Command",["CommandHandler"],function(){return{CreateCommand:function(e){return new r(e)}}}),r.prototype.toString=function(){return"[*"+this.priority+"] "},define("Unit",["CommandHandler","Command"],function(e,t){return{createUnit:function(n){return new i(n,e,t)}}}),i.prototype.tick=function(){this.commandHandler.HandleCommandQueue()},i.prototype.AddCommand=function(e){this.commandHandler.AddCommand(e)},i.prototype.GetDefaultCommand=function(){var e=Math.random()*100,t=Math.random()>.2?1:0,n=this.commandModule.CreateCommand({commandHandler:this.commandHandler,callback:function(e,n){t||(e.State.j+=1,e.State.j%=e.State.k)},finishConditions:function(e,t){return t>e.State.k},init:function(e){e.State=e.states[2],e.State.j=0},priority:-1});return n},i.prototype.SetState=function(e){this.activeState=e,this.State=this.states[e]},i.prototype.Rotate=function(){var e=this.commandModule.CreateCommand({commandHandler:this.commandHandler,callback:function(e,t){e.n=t%16},finishConditions:function(e,t){return t>100}});this.AddCommand(e)},i.prototype.go=function(e,t){var n=30,r=this.commandModule.CreateCommand({commandHandler:this.commandHandler,callback:function(t,n,r){t.x=r[n][0],t.y=r[n][1],t.State.j+=1,t.State.j%=t.State.k,t.SetState(3),t.n=e},finishConditions:function(e,t){return t>n-10},init:function(t){var r=new Array(n),i=[t.x,t.y],s=Math.cos((e+4)*(Math.PI/8)),o=Math.sin((e+4)*(Math.PI/8));for(var u=0;u<r.length-1;u++)r[u]=[Math.round(i[0]+s*u*t.speed),Math.round(i[1]+o*u*t.speed)];return r},priority:t||0});this.AddCommand(r)},i.prototype.toString=function(){return this.name},define("UnitState",[],function(){return{CreateUnitState:function(e,t,n,r,i,o,u){return new s(e,t,n,r,i,o,u)}}}),s.prototype.toString=function(){return"["+this.spriteWidth+" "+this.spriteHeight+"]"},define("Im",[],function(){return{SetUp:function(e,t,n){return new o(e,t,n)}}}),define("UnitHandler",[],function(){return{CreateHandler:function(e){return new u(e)}}}),u.prototype.Go=function(e,t){unit.go(4)},window.addEventListener("mouseup",a,!1),define("Render",["Im","UnitHandler"],function(e,t){return{CreateRender:function(n){return new f(n,e,t)}}}),define("MinimapRender",[],function(){return{CreateRender:function(e){return new l(e)}}}),l.prototype.gameLoop=function(){var e=this,t=e.gameLoop.bind(e);setTimeout(t,100),e.Render()},l.prototype.init=function(){this.miniMap=document.getElementById("minimap"),this.miniMap.height=this.height,this.miniMap.width=this.miniMap.height*(this.world.width/this.world.height),this.minimapctx=this.miniMap.getContext("2d"),this.gameLoop.bind(this)()},l.prototype.Render=function(){this.minimapctx.clearRect(0,0,this.miniMap.width,this.miniMap.height),this.DrawFrame(),this.DrawUnitsDots()},l.prototype.DrawUnitsDots=function(){var e=this.world.units;for(var t=0;t<e.length;t++){var n=e[t],r=(n.x+n.State.xSymmetry)*(this.miniMap.width/this.world.width),i=(n.y+n.State.ySymmetry)*(this.miniMap.height/this.world.height);this.minimapctx.beginPath(),this.minimapctx.strokeStyle="red",this.minimapctx.rect(r,i,2,2),this.minimapctx.stroke()}},l.prototype.DrawFrame=function(){var e=this.render.canvasOffsetX/this.world.width*this.miniMap.width,t=this.render.canvasOffsetY/this.world.height*this.miniMap.height,n=this.render.canvas_width/this.world.width*this.miniMap.width,r=this.render.canvas_height/this.world.height*this.miniMap.height;this.minimapctx.beginPath(),this.minimapctx.strokeStyle="blue",this.minimapctx.rect(e,t,n,r),this.minimapctx.stroke()};var c=!0,h=150,p=1e3,d=500,v=800,m=500;require.config({baseUrl:"js"});var e;require(["World","Unit","UnitState","Render","MinimapRender"],function(e,t,n,r,i){var s=e.CreateNewWorld(p,d),o=t.createUnit("Grenadier");o.x=s.width/2,o.y=s.height/2,s.units.push(o);for(var u=0;u<sprites.length;u++){var a=n.CreateUnitState(sprites[u].UnitName,sprites[u].SpriteHeight,sprites[u].SpriteWidth,sprites[u].NumberOfFrames,sprites[u].Id,sprites[u].XSymmetry,sprites[u].YSymmetry);o.states.push(a)}o.SetState(3),s.Run(),window.render=r.CreateRender({world:s,height:m,width:v}),window.render.init();var f=i.CreateRender({render:render,world:s,height:h});f.init(),render.CenterView(),window.unit=s.units[0]}),define("Init",function(){})})();