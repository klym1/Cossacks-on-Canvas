var sprites=[{Id:2,SpriteHeight:179,SpriteWidth:184,NumberOfFrames:24,NumberOfDirections:16,UnitName:"KOFH",XSymmetry:92},{Id:3,SpriteHeight:112,SpriteWidth:124,NumberOfFrames:36,NumberOfDirections:16,UnitName:"KOFV",XSymmetry:62},{Id:0,SpriteHeight:116,SpriteWidth:124,NumberOfFrames:16,NumberOfDirections:16,UnitName:"KOFS",XSymmetry:62},{Id:1,SpriteHeight:112,SpriteWidth:124,NumberOfFrames:16,NumberOfDirections:16,UnitName:"KOFG",XSymmetry:62}];function IM(a,b,c){this.store=a._resources;this.imagesLoaded=this.imagesAdded=0;this.add=function(a,d){var e=this,g=new Image;g.onload=function(){e.imagesLoaded++;c(e.imagesAdded,e.imagesLoaded);e.imagesAdded==e.imagesLoaded&&b()};g.src=a;this.store[d]=g;this.imagesAdded++}};function World(a,b){this.width=a;this.height=b;this.units=[];this.QuantumEpoch=this.TimeQuantumNumber=0;this.TickTime=30;this.Run=function(){var a=this;setInterval(function(){for(var f=0;f<a.units.length;f++)a.units[f].tick();a.TimeQuantumNumber++;1024==a.TimeQuantumNumber&&(a.QuantumEpoch++,a.TimeQuantumNumber=0)},this.TickTime)}};function Command(a){this.commandHandler=a.commandHandler;this.callback=a.callback;this.finishConditions=a.finishConditions;this.i=0;this.initialised=!1;this.init=a.init;this.initData={};this.priority=a.priority||0;this.Execute=function(){!1===this.initialised&&void 0!==this.init&&(this.initData=this.init(this.commandHandler.unit),this.initialised=!0);this.callback(this.commandHandler.unit,this.i,this.initData);this.commandHandler.commandIsExecuting=!0;this.i++;!0===this.finishConditions(this.commandHandler.unit,
this.i)&&(this.commandHandler.commandIsExecuting=!1)}}Command.prototype.toString=function(){return"[*"+this.priority+"] "};function Unit(a){this.name=a;this.hp=100;this.speed=2.3;this.y=this.x=0;this.states=[];this.activeState=this.n=0;this.commandHandler=new CommandHandler(this);this.State={}}Unit.prototype.tick=function(){this.commandHandler.HandleCommandQueue()};Unit.prototype.AddCommand=function(a){this.commandHandler.AddCommand(a)};
Unit.prototype.GetDefaultCommand=function(){Math.random();var a=.2<Math.random()?1:0;return new Command({commandHandler:this.commandHandler,callback:function(b,c){a||(b.State.j+=1,b.State.j%=b.State.k)},finishConditions:function(a,c){return c>a.State.k},init:function(a){a.State=a.states[2];a.State.j=0},priority:-1})};Unit.prototype.SetState=function(a){this.activeState=a;this.State=this.states[a]};
Unit.prototype.Rotate=function(){var a=new Command({commandHandler:this.commandHandler,callback:function(a,c){a.n=c%16},finishConditions:function(a,c){return 100<c}});this.AddCommand(a)};
Unit.prototype.go=function(a,b){var c=new Command({commandHandler:this.commandHandler,callback:function(c,d,b){c.x=b[d][0];c.y=b[d][1];c.State.j+=1;c.State.j%=c.State.k;c.SetState(3);c.n=a},finishConditions:function(a,c){return 90<c},init:function(c){for(var d=Array(100),b=[c.x,c.y],g=Math.cos(Math.PI/8*(a+4)),h=Math.sin(Math.PI/8*(a+4)),k=0;k<d.length-1;k++)d[k]=[Math.round(b[0]+g*k*c.speed),Math.round(b[1]+h*k*c.speed)];return d},priority:b||0});this.AddCommand(c)};Unit.prototype.toString=function(){return this.name};function PriorityQueue(a){this.criteria=a;this.length=0;this.queue=[]}PriorityQueue.prototype.IsEmpty=function(){return 0===this.queue.length};PriorityQueue.prototype.insert=function(a){if(!a.hasOwnProperty(this.criteria))throw"Cannot insert "+a+" because it does not have a property by the name of "+this.criteria+".";this.queue.push(a);this.length++;this.bubbleUp(this.length-1)};PriorityQueue.prototype.getHighestPriorityElement=function(){return this.queue[0]};
PriorityQueue.prototype.shiftHighestPriorityElement=function(){this.length--;return this.queue.shift()};PriorityQueue.prototype.bubbleUp=function(a){if(0!==a)for(a=this.queue.length-1;0<a;a--)this.queue[a][this.criteria]>this.queue[a-1][this.criteria]&&this.swap(a-1,a)};PriorityQueue.prototype.swap=function(a,b){var c=this.queue[a];this.queue[a]=this.queue[b];this.queue[b]=c};function CommandHandler(a){this.unit=a;this.commandsQueue=new PriorityQueue("priority");this.commandIsExecuting=this.HighPriorityInterruption=!1;this.currentCommand=null}CommandHandler.prototype.AddCommand=function(a){this.commandsQueue.insert(a)};
CommandHandler.prototype.HandleCommandQueue=function(){if(this.commandsQueue.IsEmpty()){if(!1===this.commandIsExecuting){var a=this.unit.GetDefaultCommand();this.AddCommand(a)}}else a=this.commandsQueue.getHighestPriorityElement(),this.currentCommand.priority<a.priority&&(this.AddCommand(this.currentCommand),this.HighPriorityInterruption=!0);if(!1===this.commandIsExecuting||this.HighPriorityInterruption)this.currentCommand=this.commandsQueue.shiftHighestPriorityElement(),this.HighPriorityInterruption=
!1;this.currentCommand.Execute()};function UnitState(a,b,c,f,d,e){this.spriteName=a;this.spriteWidth=c;this.spriteHeight=b;this.j=0;this.k=f;this.Id=d;this.xSymmetry=e}UnitState.prototype.toString=function(){return"["+this.spriteWidth+" "+this.spriteHeight+"]"};(function(){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(c,b){var e=(new Date).getTime(),g=Math.max(0,16-(e-a)),h=window.setTimeout(function(){c(e+g)},g);a=e+g;return h});window.cancelAnimationFrame||(window.cancelAnimationFrame=
function(a){clearTimeout(a)})})();function Render(a){var b=new Date;this._resources={};this.world=a;this.gameLoop=function(){var a=this.gameLoop.bind(this);window.requestAnimationFrame(a);this.RenderUnits()};this.uppendLine=function(a){var f=new Date-b,d=Math.floor(f%36E5/6E4),e=Math.floor(f%6E4/1E3),f=Math.floor(f%1E3);document.getElementById("loading-container").innerHTML+="["+d+":"+e+"."+f+"] "+a+"<p>"};this.init=function(){var a=this;this.canvas=document.getElementById("can");this.canvas.width=800;this.canvas.height=500;this.canvas_height=
this.canvas.height;this.canvas_width=this.canvas.width;this.ctx=this.canvas.getContext("2d");for(var b=new IM(this,function(){a.uppendLine("Loading finished in ");a.gameLoop.bind(a)()},function(b,d){a.uppendLine((d/b*100+"").substring(0,6)+" %")}),d=0;d<sprites.length;d++)b.add("sprites_png/"+sprites[d].UnitName+".png",sprites[d].UnitName)};this.RenderUnits=function(){this.WriteStatusInfo(this.world);this.ctx.clearRect(0,0,this.canvas_width,this.canvas_height);for(var a=this.world.units,b=a.length-
1;0<=b;b--){var d=a[b],e=d.State,g=e.spriteWidth,h=e.spriteHeight;this.ctx.drawImage(this._resources[e.spriteName],g*d.n,h*e.j,g,h,d.x,d.y,g,h);this.ctx.stroke()}};this.WriteStatusInfo=function(a){!0===SHOW_DEBUG_INFO?(document.getElementById("world-info").innerHTML=this.MaterializeStatusData(this.GetInfoRecursively(a)),document.getElementById("unit-info").innerHTML=this.MaterializeStatusData(this.GetInfoRecursively(a.units[0].commandsQueue))):(document.getElementById("world-info").innerHTML=null,
document.getElementById("unit-info").innerHTML=null)};this.MaterializeStatusData=function(a){for(var b="",d=0;d<a.length;d++)var e=a[d],b=b+(e[0]+": "+e[1]+"</p>");return b};this.GetInfoRecursively=function(a){var b=[],d;for(d in a)a.hasOwnProperty(d)&&"function"!=typeof a[d]&&b.push([d,a[d]]);return b}};var SHOW_DEBUG_INFO=!0,world=function(){var a=new World(5E3,5E3),b=new Unit("Grenadier");b.x=500;b.y=100;a.units.push(b);for(var c=0;c<sprites.length;c++){var f=new UnitState(sprites[c].UnitName,sprites[c].SpriteHeight,sprites[c].SpriteWidth,sprites[c].NumberOfFrames,sprites[c].Id,sprites[c].XSymmetry);b.states.push(f)}b.SetState(3);return a}();world.Run();var render=new Render(world);render.init();var unit=world.units[0];